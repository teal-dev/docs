---
title: "Auto-categorization"
description: "How Teal's auto-categorization pipeline works"
icon: #"folder-gear"
---

## Overview

Categorizing transactions is the process of assigning a ledger to a transaction and is the core of accounting and bookkeeping.

Teal uses a customizable pipeline to automate as much of this as possible to minimize the number of transactions a user has to manually categorize. If no categorization step matches a transaction, the transaction will be categorized into either the **Uncategorized Cash Inflow** or **Uncategorized Cash Outflow** ledger.

All auto-categorization steps are disabled by default, and will not run until manually enabled in the [developer portal](https://developer.teal.dev).

---

## Auto-categorization pipeline

![Auto-categorizer pipeline](/images/auto-categorizer-pipeline.png)

When a transaction is created, it is sent to the categorization pipeline where categorizers apply different rules to a transaction and try to match it to an instance’s ledgers.

We have four categorizers that run in sequence:

1. Transfers between accounts
2. Platform categorization rules
3. Similar transactions
4. AI Categorization

If a categorizer selects a ledger, the subsequent categorizers won’t be run. For example, if a transaction is identified as a transfer between accounts, the transaction will not be tested against the **platform categorization rules** or **similar transactions** categorizers.

### Categorizers

<Steps>
    <Step title="Transfers between accounts">
        This categorizer detects transfers between accounts by looking for unmatched line entries in other ledgers with a `financial_account_type` within a 7 day window of the transaction. It only identifies these transactions after both the inflow and outflow exist in the system.

        If you or your user know that a cash outflow is a transfer between accounts before the corresponding inflow has been received, you can [manually categorize](/interfaces/reviewing_transactions) the line entry to the **Transfers Between Accounts** ledger. This is a special ledger that exists in all [chart of accounts templates](/accounting_package/platform_gl/configuration/chart_of_accounts_config)
        
        The system will then automatically categorize the corresponding inflow when it arrives.
    </Step>
    <Step title="Platform categorization rules">
        Platforms have the ability to set their own categorization rules. This feature enables you to write expressions, which, when matched, will automatically categorize a transaction into a specific ledger. 
        
        This is useful if you are familiar with your customers' spending and can help reduce the amount of time your customers spend manually categorizing transactions. For example, you might create a platform rule that puts every transaction with the description "UNITED AIRLINES" into a travel expenses ledger.

        Categorization rules check transactions using an expression and priority. If a transaction matches multiple rules, the one with higher priority is selected.

        Because categorization rules are set at the **Platform level** these rules will apply to every transaction, regardless of instance, on your platform. 
        
        We don’t currently offer Instance level categorization rules. Please reach out to your Teal contact if this is an important feature to you.

        See [Crafting platform rules](#crafting-platform-rules) below to learn how to write categorization rules in the [developer portal](https://developer.teal.dev).
    </Step>
    <Step title="Similar transactions">
        This categorizer selects a category based on similar transactions that have previously been categorized by either rules, ChatGPT, or the user. For this categorizer to work, each Transaction's `description` must be 80% similar and the `amount` must be within 10%.
    </Step>
    <Step title="AI Categorization">
        This categorizer sends the Transaction object along with a list ledgers and asks ChatGPT to select one. It can sometimes take up to 5 minutes for for this categorizer to run. 
        
        To prioritize the end-user's experience, the transaction is posted to either the **Uncategorized Cash Inflow** or **Uncategorized Cash Outflow** ledger while this is running and can be [manually categorized](/interfaces/reviewing_transactions). Manually categorizing the transaction stops the categorizer.

        To enable AI categorization, please reach out to your Teal contact. You’ll first need to submit example transactions from your users, and then Teal will train a custom AI auto-categorization model for your platform.
    </Step>
</Steps>

---

## Uncategorized transactions

Transactions can often lack sufficient context and data and cannot be auto-categorized — for example, a bank transaction which is labelled “Payment”.

When a transactions goes through all of the categorizers but does not find a match, it is categorized as either **Uncategorized Cash Inflow** or **Uncategorized Cash Outflow**. These special ledgers are hardcoded into each [chart of accounts template](/accounting_package/platform_gl/configuration/chart_of_accounts_config.mdx).

In order for books to be balanced, it is necessary to create a user experience to allow users to manually categorize transactions. For steps on how to build an interface like this, see [reviewing transactions](/interfaces/reviewing_transactions).

---

## Crafting platform rules

A rule consists of three components:

- **Expression**: A conditional statement that is evaluated against each transaction to determine whether it satisfies the criteria of the rule.
- **Priority**: If multiple rules match a transaction, the rule with the highest priority will be implemented first.
- **Destination Ledger**: This is the name of the ledger into which the transaction will be categorized if the rule conditions are met. If the specified ledger name doesn’t exist in a instance’s chart of accounts, the system will disregard the rule.

### Expressions
Expressions are written by comparing a part of the Transaction object with text, numbers, booleans, or dates. 

**The Transaction object**

The entire `Transaction` object is accessed via the symbol `t` and reference specific fields using `.`, for example, `t.description` or `t.amount`.

```json
{
    {
      "amount": 100,
      "datetime": "2022-01-01T00:00:00Z",
      "description": "Shell Gas Bar 4124",
      "id": "t_9237232",
      "metadata": {
        // ...
      },
      "posted_status": "posted",
      "review_status": "reviewed"
    }
}
```

If `metadata` was added to the `Transaction`, you can reference it through `t.metadata`. See [submitting transactions](/accounting_package/platform_gl/transactions/submitting_transactions) for more information on adding metadata to your transactions.

#### Operators and literals

Expressions may include the following operators and literals:

        <AccordionGroup>
            <Accordion title="Operators">
                - `and`, `or` for logical AND and OR operations
                - `()` for defining the order of operations
                - `==`, `>`, `>=`, `<`, `<=` for equality and comparison
                - `+`, `-`, `*`, `/`, `%` for mathematical operations
            </Accordion>
            <Accordion title="If/else Expression">
                - `true_expr if boolean_expr else false_expr`
            </Accordion>
            <Accordion title="Literals">
                - Strings: `"string"`
                - Numbers: `1.23`
                - Booleans: `True`, `False`
                - Datetime: `datetime("2023-01-10T00:00:00.000Z")`
            </Accordion>
        </AccordionGroup>

#### Regular Expressions

You can also use regular expressions in your rule's expression using the `match(pattern, text)` function. You can learn more about regular expressions and their syntax [here](https://developers.google.com/edu/python/regular-expressions).

#### Examples

##### Payments to a Specific Vendor

A rule that checks if the transaction description contains "Slack":

```python
match("Slack", t.description)
```

##### Payments to a specific merchant over a given threshold amount

A rule that applies to any transaction where the vendor is "Chevron" and the amount is more than \$50:

```python
match("Chevron", t.description) and t.amount > 50
```

##### Transactions with Certain Metadata

A rule that looks for transactions with a `counterparty` attribute in the metadata set to "Sophie's Contracting LLC":

```python
t.metadata.counterparty == "Sophie's Contracting LLC"
```




